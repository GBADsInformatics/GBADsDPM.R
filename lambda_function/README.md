# GBADsDPM.R Lambda Function

This is an AWS Lambda function for running the GBADs Dynamic Population Model (DPM) using R and Python. The Lambda function is designed to process S3 events, download user-uploaded parameter files, execute the R model, and upload results back to S3.

## Features
- Handles S3 events to process uploaded parameter files
- Runs the DPM model in R via a Python Lambda handler
- Preserves S3 key prefixes for output files
- Supports local testing with Docker and AWS Lambda Runtime Interface Emulator

## Production
Although the CI/CD pipeline automatically builds the docker image, you need to update the lambda function manually to use the new image.

> IMPORTANT! You must wait for the pipeline to succeed (>5 minutes)

1. Login to AWS & navigate to Lambda
2. Select region us-east-2
3. Select dpm-model-runner
4. "Deploy new image"
5. "Browse iamges"
6. Select the *latest* image & save

## Getting Started

### Prerequisites
- Docker
- AWS credentials for S3 access

### Build the Docker Image
```
docker build -t dpm-lambda -f lambda_function/Dockerfile .
```

### Download AWS Lambda Runtime Interface Emulator
```
curl -Lo aws-lambda-rie https://github.com/aws/aws-lambda-runtime-interface-emulator/releases/latest/download/aws-lambda-rie
chmod +x aws-lambda-rie
```

### Run the Lambda Locally
```
docker run \
    -e AWS_ACCESS_KEY_ID=s3_user_key \
    -e AWS_SECRET_ACCESS_KEY=s3_user_secret \
    -e AWS_REGION=ca-central-1 \
    -e AWS_LAMBDA_RUNTIME_API=127.0.0.1:8080 \
    -e RDS_HOST=... \ # for testing with model tracking
    -e RDS_DATABASE=... \
    -e RDS_USER=... \
    -e RDS_PASSWORD=... \
    -v "$PWD/aws-lambda-rie:/aws-lambda-rie" \
    --entrypoint /aws-lambda-rie \
    -p 9000:8080 \
    dpm-lambda /usr/local/bin/python -m awslambdaric lambda_handler.lambda_handler
```

### Test the Lambda Function Locally
```
curl -XPOST "http://localhost:9000/2015-03-31/functions/function/invocations" -d '{"Records":[{"s3":{"bucket":{"name":"gbads-modelling-private"},"object":{"key":"params_cattle.yaml"}}}]}'
```

## File Structure
- `lambda_function/lambda_handler.py`: Main Lambda handler (Python)
- `lambda_function/Dockerfile`: Dockerfile for Lambda deployment
- `lambda_function/requirements.txt`: Python dependencies

## S3 Key Prefix Handling
Output files are uploaded to S3 under the prefix:
```
model_output/<trimmed_input_prefix>/
```
Where `<trimmed_input_prefix>` is the input file's prefix with the first directory removed.


For Example:

If your input file is uploaded to the S3 bucket at:
```
model_input/user123/projectA/params_cattle.yaml
```
The output file(s) will be uploaded to:
```
model_output/user123/projectA/<output_file(s)>.csv
```
where `<output_file(s)>.csv` are the result files generated by the model.

## License
See `LICENSE.txt` for details.

## Authors
- William Fitzjohn
- Matthew Szurkowski
